#!/bin/bash
set -eo pipefail

pharod="$(command -v pharod)"
if [[ -z $pharod ]]; then
  echo "pharod not found in $PATH, please check it's installed properly"
  exit 1
fi

if pgrep -qx pharod; then
  echo "You can only have one instance of pharod running at one time"
  exit 1
fi

if command -v boot2docker >/dev/null; then
  if [[ "poweroff" = "$(boot2docker status)" ]]; then
    echo "boot2docker not running, please start it with 'boot2docker start'"
    exit 1
  fi

  if [[ -z $DOCKER_FIRST_EPHEMERAL_PORT ]]; then
    # This is what Docker also reads the first port from.
    DOCKER_FIRST_EPHEMERAL_PORT="$(boot2docker ssh cat /proc/sys/net/ipv4/ip_local_port_range | egrep -o '^\d+')"
  fi

  eval "$(boot2docker shellinit 2>/dev/null)"
fi

exec sudo sh -c "DOCKER_HOST='$DOCKER_HOST' DOCKER_TLS_VERIFY='$DOCKER_TLS_VERIFY' DOCKER_CERT_PATH='$DOCKER_CERT_PATH' DOCKER_FIRST_EPHEMERAL_PORT='$DOCKER_FIRST_EPHEMERAL_PORT' '$pharod' -d"
