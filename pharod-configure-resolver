#!/bin/bash

set -e

if ! [[ $(id -u) -eq "0" ]]; then
  echo "This configures pharod as a DNS resolver on this system."
  echo "This must be run as root. You may be asked to authenticate..."
  exec sudo -- "$0" "$@"
fi

echo "* Configuring resolver"
cat >/etc/resolver/pharod <<EOF
# Carefully generated by pharod
nameserver 127.0.0.1
port 49152
EOF

echo "* Prodding OS X to notice new configuration"
# Borrowed from pow's install.sh
location=$(networksetup -getcurrentlocation)
templocation="pharod$$"
networksetup -createlocation "$templocation" >/dev/null 2>&1
networksetup -switchtolocation "$templocation" >/dev/null 2>&1
networksetup -switchtolocation "$location" >/dev/null 2>&1
networksetup -deletelocation "$templocation" >/dev/null 2>&1

echo "* Done!"
